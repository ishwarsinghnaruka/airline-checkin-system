<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Airline Check-in System - Database Concurrency Demo</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .header h1 {
        color: #1e3c72;
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .header .subtitle {
        color: #666;
        font-size: 1.1rem;
        margin-bottom: 20px;
      }

      .demo-controls {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
      }

      .btn {
        background: #2a5298;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(42, 82, 152, 0.3);
      }

      .btn:hover {
        background: #1e3c72;
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(42, 82, 152, 0.4);
      }

      .btn-danger {
        background: #e74c3c;
        box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
      }

      .btn-danger:hover {
        background: #c0392b;
        box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
      }

      .btn-success {
        background: #27ae60;
        box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
      }

      .btn-success:hover {
        background: #229954;
        box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
      }

      .main-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-bottom: 30px;
      }

      .panel {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .panel h2 {
        color: #1e3c72;
        margin-bottom: 20px;
        font-size: 1.5rem;
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
      }

      .login-section {
        margin-bottom: 25px;
      }

      .input-group {
        margin-bottom: 20px;
      }

      .input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #555;
      }

      .input-group input,
      .input-group select {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
      }

      .input-group input:focus,
      .input-group select:focus {
        outline: none;
        border-color: #2a5298;
        box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.1);
      }

      .seat-map {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 8px;
        margin: 20px 0;
        max-width: 350px;
        margin-left: auto;
        margin-right: auto;
      }

      .seat {
        width: 45px;
        height: 45px;
        border: 2px solid #ddd;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-weight: bold;
        font-size: 11px;
        transition: all 0.3s ease;
        position: relative;
      }

      .seat.available {
        background: #27ae60;
        color: white;
        border-color: #229954;
      }

      .seat.taken {
        background: #e74c3c;
        color: white;
        border-color: #c0392b;
        cursor: not-allowed;
      }

      .seat.processing {
        background: #f39c12;
        color: white;
        border-color: #e67e22;
        cursor: not-allowed;
        animation: pulse 1.5s infinite;
      }

      .seat.selected {
        background: #9b59b6;
        color: white;
        border-color: #8e44ad;
        transform: scale(1.1);
      }

      .seat:hover.available {
        transform: scale(1.05);
        box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.6;
        }
        100% {
          opacity: 1;
        }
      }

      .legend {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 20px 0;
        flex-wrap: wrap;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
      }

      .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        border: 2px solid #ddd;
      }

      .status-panel {
        grid-column: 1 / -1;
      }

      .status-message {
        padding: 15px;
        margin: 10px 0;
        border-radius: 8px;
        font-weight: 500;
      }

      .status-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status-warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      .status-info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .metrics {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }

      .metric-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        border: 2px solid #e9ecef;
      }

      .metric-card h3 {
        color: #2a5298;
        margin-bottom: 10px;
      }

      .metric-value {
        font-size: 2rem;
        font-weight: bold;
        color: #1e3c72;
      }

      .test-results {
        margin-top: 20px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        border: 2px solid #e9ecef;
      }

      .result-comparison {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin: 15px 0;
      }

      .result-card {
        padding: 15px;
        border-radius: 8px;
        border: 2px solid #ddd;
      }

      .result-unsafe {
        background: #ffeaa7;
        border-color: #fdcb6e;
      }

      .result-safe {
        background: #a8e6cf;
        border-color: #00b894;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #2a5298;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .hidden {
        display: none;
      }

      .passenger-info {
        background: #e8f4fd;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 2px solid #bee5eb;
      }

      .flight-info {
        background: #e8f5e8;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 2px solid #c3e6cb;
      }

      @media (max-width: 768px) {
        .main-content {
          grid-template-columns: 1fr;
        }

        .demo-controls {
          flex-direction: column;
          align-items: center;
        }

        .result-comparison {
          grid-template-columns: 1fr;
        }

        .metrics {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Header Section -->
      <div class="header">
        <h1>✈️ Airline Check-in System</h1>
        <p class="subtitle">Database Concurrency Control Demonstration</p>
        <div class="demo-controls">
          <button class="btn btn-danger" onclick="testConcurrency('unsafe')">
            Test UNSAFE Method (Race Condition)
          </button>
          <button class="btn btn-success" onclick="testConcurrency('safe')">
            Test SAFE Method (SKIP LOCKED)
          </button>
          <button class="btn" onclick="resetSystem()">Reset All Seats</button>
          <button class="btn" onclick="loadSeatMap()">Refresh Seat Map</button>
        </div>
      </div>

      <!-- Main Content -->
      <div class="main-content">
        <!-- Individual Check-in Panel -->
        <div class="panel">
          <h2>Individual Check-in</h2>

          <div class="login-section">
            <div class="input-group">
              <label for="pnrInput">Enter your PNR:</label>
              <input
                type="text"
                id="pnrInput"
                placeholder="e.g., PNR001"
                value="PNR001"
              />
            </div>
            <button class="btn" onclick="loginWithPNR()">Check-in</button>
          </div>

          <div id="passengerInfo" class="passenger-info hidden"></div>
          <div id="flightInfo" class="flight-info hidden"></div>

          <div class="input-group">
            <label for="methodSelect">Booking Method:</label>
            <select id="methodSelect">
              <option value="safe">Safe Method (SKIP LOCKED)</option>
              <option value="unsafe">
                Unsafe Method (Race Condition Prone)
              </option>
            </select>
          </div>

          <button
            class="btn btn-success"
            id="autoAssignBtn"
            onclick="autoAssignSeat()"
            disabled
          >
            Auto-Assign Next Available Seat
          </button>
        </div>

        <!-- Seat Map Panel -->
        <div class="panel">
          <h2>Live Seat Map - Flight AA123</h2>

          <div class="legend">
            <div class="legend-item">
              <div class="legend-color" style="background: #27ae60"></div>
              <span>Available</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #e74c3c"></div>
              <span>Taken</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background: #f39c12"></div>
              <span>Processing</span>
            </div>
          </div>

          <div id="seatMap" class="seat-map">
            <!-- Seat map will be dynamically generated -->
          </div>

          <div class="metrics">
            <div class="metric-card">
              <h3>Available Seats</h3>
              <div class="metric-value" id="availableCount">-</div>
            </div>
            <div class="metric-card">
              <h3>Booked Seats</h3>
              <div class="metric-value" id="bookedCount">-</div>
            </div>
            <div class="metric-card">
              <h3>Processing</h3>
              <div class="metric-value" id="processingCount">0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Status and Results Panel -->
      <div class="panel status-panel">
        <h2>System Status & Test Results</h2>
        <div id="statusMessages"></div>

        <div class="test-results">
          <h3>Concurrency Test Results</h3>
          <div id="testResults">
            <p>
              Click "Test UNSAFE Method" or "Test SAFE Method" to run
              concurrency demonstrations.
            </p>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Global state management
      let currentUser = null;
      let seatMap = new Map();
      let testRunning = false;

      // API configuration
      const API_BASE = window.location.origin;

      // Initialize the application
      document.addEventListener("DOMContentLoaded", function () {
        loadSeatMap();
        checkServerHealth();
      });

      // Check if backend server is running
      async function checkServerHealth() {
        try {
          const response = await fetch(`${API_BASE}/health`);
          const health = await response.json();

          if (health.status === "OK") {
            addStatusMessage(
              "✅ Backend server connected successfully",
              "success"
            );
          } else {
            addStatusMessage(
              "⚠️ Backend server responded but may have issues",
              "warning"
            );
          }
        } catch (error) {
          addStatusMessage(
            "❌ Cannot connect to backend server. Make sure server is running on port 3000.",
            "error"
          );
        }
      }

      // PNR login functionality
      async function loginWithPNR() {
        const pnr = document.getElementById("pnrInput").value.trim();

        if (!pnr) {
          addStatusMessage("Please enter a PNR", "error");
          return;
        }

        try {
          const response = await fetch(`${API_BASE}/checkin/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ pnr }),
          });

          const data = await response.json();

          if (!response.ok) {
            addStatusMessage(`Login failed: ${data.error}`, "error");
            return;
          }

          currentUser = data;
          displayUserInfo(data);
          document.getElementById("autoAssignBtn").disabled = false;
          addStatusMessage(
            `Welcome ${data.passenger.firstName}! Ready for check-in.`,
            "success"
          );
        } catch (error) {
          addStatusMessage(`Login error: ${error.message}`, "error");
        }
      }

      // Display user information after successful login
      function displayUserInfo(userData) {
        const passengerInfo = document.getElementById("passengerInfo");
        const flightInfo = document.getElementById("flightInfo");

        passengerInfo.innerHTML = `
                <h4>Passenger Information</h4>
                <p><strong>Name:</strong> ${userData.passenger.firstName} ${
          userData.passenger.lastName
        }</p>
                <p><strong>PNR:</strong> ${userData.booking.pnr}</p>
                <p><strong>Status:</strong> ${userData.booking.status}</p>
                <p><strong>Current Seat:</strong> ${
                  userData.booking.currentSeat?.seatNumber || "Not assigned"
                }</p>
            `;

        flightInfo.innerHTML = `
                <h4>Flight Information</h4>
                <p><strong>Flight:</strong> ${userData.flight.flightNumber}</p>
                <p><strong>Route:</strong> ${userData.flight.departure} → ${
          userData.flight.arrival
        }</p>
                <p><strong>Departure:</strong> ${new Date(
                  userData.flight.departureTime
                ).toLocaleString()}</p>
            `;

        passengerInfo.classList.remove("hidden");
        flightInfo.classList.remove("hidden");
      }

      // Auto-assign seat functionality
      async function autoAssignSeat() {
        if (!currentUser) {
          addStatusMessage("Please login first", "error");
          return;
        }

        const method = document.getElementById("methodSelect").value;
        const pnr = currentUser.booking.pnr;

        try {
          addStatusMessage(
            `🔄 Assigning seat using ${method.toUpperCase()} method...`,
            "info"
          );

          const response = await fetch(
            `${API_BASE}/checkin/auto-assign-seat-${method}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ pnr }),
            }
          );

          const result = await response.json();

          if (!response.ok) {
            addStatusMessage(
              `❌ Seat assignment failed: ${result.error}`,
              "error"
            );
            return;
          }

          addStatusMessage(
            `✅ Seat ${
              result.seatNumber
            } assigned successfully using ${method.toUpperCase()} method!`,
            "success"
          );

          // Refresh seat map and user info
          loadSeatMap();
          loginWithPNR(); // Refresh user info
        } catch (error) {
          addStatusMessage(`❌ Assignment error: ${error.message}`, "error");
        }
      }

      // Load and display seat map
      async function loadSeatMap() {
        try {
          const response = await fetch(`${API_BASE}/flights/AA123/seats`);
          const flightData = await response.json();

          if (!response.ok) {
            addStatusMessage(
              `Failed to load seat map: ${flightData.error}`,
              "error"
            );
            return;
          }

          renderSeatMap(flightData.seats);
          updateMetrics(flightData);
        } catch (error) {
          addStatusMessage(`Error loading seat map: ${error.message}`, "error");
        }
      }

      // Render the seat map visualization
      function renderSeatMap(seats) {
        const seatMapContainer = document.getElementById("seatMap");
        seatMapContainer.innerHTML = "";

        // Group seats by row for better organization
        const seatsByRow = groupSeatsByRow(seats);

        // Render first few rows for demonstration
        const displayRows = Object.keys(seatsByRow).slice(0, 8);

        displayRows.forEach((row) => {
          seatsByRow[row].forEach((seat) => {
            const seatElement = createSeatElement(seat);
            seatMapContainer.appendChild(seatElement);
          });
        });

        seatMap.clear();
        seats.forEach((seat) => seatMap.set(seat.id, seat));
      }

      // Group seats by row number for organized display
      function groupSeatsByRow(seats) {
        const grouped = {};

        seats.forEach((seat) => {
          const row = seat.seatNumber.match(/\d+/)[0];
          if (!grouped[row]) {
            grouped[row] = [];
          }
          grouped[row].push(seat);
        });

        // Sort seats within each row by letter
        Object.keys(grouped).forEach((row) => {
          grouped[row].sort((a, b) => a.seatNumber.localeCompare(b.seatNumber));
        });

        return grouped;
      }

      // Create individual seat element
      function createSeatElement(seat) {
        const seatDiv = document.createElement("div");
        seatDiv.className = `seat ${seat.isAvailable ? "available" : "taken"}`;
        seatDiv.textContent = seat.seatNumber;
        seatDiv.title = `Seat ${seat.seatNumber} - ${seat.seatType} - $${seat.price}`;

        if (seat.isAvailable) {
          seatDiv.onclick = () => selectSpecificSeat(seat.id, seat.seatNumber);
        }

        return seatDiv;
      }

      // Handle specific seat selection
      async function selectSpecificSeat(seatId, seatNumber) {
        if (!currentUser) {
          addStatusMessage("Please login first to select a seat", "error");
          return;
        }

        const confirmed = confirm(`Select seat ${seatNumber}?`);
        if (!confirmed) return;

        const method = document.getElementById("methodSelect").value;

        try {
          addStatusMessage(`🔄 Booking seat ${seatNumber}...`, "info");

          const response = await fetch(
            `${API_BASE}/checkin/select-seat-${method}`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                pnr: currentUser.booking.pnr,
                seatId: seatId,
              }),
            }
          );

          const result = await response.json();

          if (!response.ok) {
            addStatusMessage(`❌ Booking failed: ${result.error}`, "error");
            return;
          }

          addStatusMessage(
            `✅ Seat ${result.seatNumber} booked successfully!`,
            "success"
          );
          loadSeatMap();
          loginWithPNR(); // Refresh user info
        } catch (error) {
          addStatusMessage(`❌ Booking error: ${error.message}`, "error");
        }
      }

      // Update seat metrics display
      function updateMetrics(flightData) {
        const available = flightData.availableCount;
        const total = flightData.totalSeats;
        const booked = total - available;

        document.getElementById("availableCount").textContent = available;
        document.getElementById("bookedCount").textContent = booked;
        document.getElementById("processingCount").textContent = "0";
      }

      // Test concurrency with multiple simulated users
      async function testConcurrency(method) {
        if (testRunning) {
          addStatusMessage("Test already running, please wait...", "warning");
          return;
        }

        testRunning = true;
        addStatusMessage(
          `🚀 Starting concurrency test with ${method.toUpperCase()} method...`,
          "info"
        );

        try {
          // Reset system first
          await resetSystem();
          await new Promise((resolve) => setTimeout(resolve, 1000));

          const numUsers = 20; // Reduced number for frontend demo
          const promises = [];
          const startTime = performance.now();

          // Create multiple concurrent requests
          for (let i = 1; i <= numUsers; i++) {
            const pnr = `PNR${String(i).padStart(3, "0")}`;

            const promise = fetch(
              `${API_BASE}/checkin/auto-assign-seat-${method}`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ pnr }),
              }
            )
              .then((response) => response.json())
              .then((data) => ({ success: true, data, user: i }))
              .catch((error) => ({
                success: false,
                error: error.message,
                user: i,
              }));

            promises.push(promise);
          }

          // Execute all requests simultaneously
          const results = await Promise.all(promises);
          const endTime = performance.now();
          const duration = Math.round(endTime - startTime);

          // Analyze results
          const successful = results.filter((r) => r.success && r.data.success);
          const failed = results.filter((r) => !r.success || !r.data.success);

          // Check for duplicate seat assignments (race condition detection)
          const seatAssignments = successful.map((r) => r.data.seatNumber);
          const uniqueSeats = [...new Set(seatAssignments)];
          const duplicates = successful.length - uniqueSeats.length;

          displayTestResults(method, {
            totalUsers: numUsers,
            successful: successful.length,
            failed: failed.length,
            duration: duration,
            duplicates: duplicates,
            uniqueSeats: uniqueSeats.length,
          });

          // Refresh seat map to show final state
          await loadSeatMap();
        } catch (error) {
          addStatusMessage(`❌ Test failed: ${error.message}`, "error");
        } finally {
          testRunning = false;
        }
      }

      // Display comprehensive test results
      function displayTestResults(method, results) {
        const testResultsDiv = document.getElementById("testResults");

        const resultClass =
          method === "unsafe" ? "result-unsafe" : "result-safe";
        const methodLabel =
          method === "unsafe"
            ? "UNSAFE (Race Condition)"
            : "SAFE (SKIP LOCKED)";

        let raceConditionStatus = "";
        if (results.duplicates > 0) {
          raceConditionStatus = `🚨 RACE CONDITION DETECTED: ${results.duplicates} duplicate assignments`;
        } else {
          raceConditionStatus = `✅ No race conditions detected`;
        }

        testResultsDiv.innerHTML = `
                <div class="result-card ${resultClass}">
                    <h4>${methodLabel} Test Results</h4>
                    <p><strong>Total Users:</strong> ${results.totalUsers}</p>
                    <p><strong>Successful Assignments:</strong> ${
                      results.successful
                    }</p>
                    <p><strong>Failed Assignments:</strong> ${
                      results.failed
                    }</p>
                    <p><strong>Unique Seats Assigned:</strong> ${
                      results.uniqueSeats
                    }</p>
                    <p><strong>Duration:</strong> ${results.duration}ms</p>
                    <p><strong>Success Rate:</strong> ${(
                      (results.successful / results.totalUsers) *
                      100
                    ).toFixed(1)}%</p>
                    <p><strong>Race Condition Status:</strong> ${raceConditionStatus}</p>
                </div>
            `;

        // Add summary message
        if (method === "unsafe" && results.duplicates > 0) {
          addStatusMessage(
            `❌ UNSAFE method test completed: Race condition occurred! ${results.duplicates} users got duplicate seats.`,
            "error"
          );
        } else if (method === "safe") {
          addStatusMessage(
            `✅ SAFE method test completed: ${results.successful}/${results.totalUsers} users successfully assigned unique seats.`,
            "success"
          );
        } else {
          addStatusMessage(
            `✅ Test completed: ${results.successful}/${results.totalUsers} successful assignments in ${results.duration}ms`,
            "success"
          );
        }
      }

      // Reset all seats to available state
      async function resetSystem() {
        try {
          addStatusMessage("🔄 Resetting all seats...", "info");

          const response = await fetch(`${API_BASE}/admin/reset-all-seats`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
          });

          const result = await response.json();

          if (!response.ok) {
            addStatusMessage(`Reset failed: ${result.error}`, "error");
            return;
          }

          addStatusMessage(`✅ ${result.message}`, "success");
          await loadSeatMap();

          // Clear current user if they had a seat assigned
          if (currentUser) {
            loginWithPNR(); // Refresh user info
          }
        } catch (error) {
          addStatusMessage(`Reset error: ${error.message}`, "error");
        }
      }

      // Add status message to the UI
      function addStatusMessage(message, type = "info") {
        const statusContainer = document.getElementById("statusMessages");
        const messageDiv = document.createElement("div");

        messageDiv.className = `status-message status-${type}`;
        messageDiv.innerHTML = `${new Date().toLocaleTimeString()}: ${message}`;

        statusContainer.insertBefore(messageDiv, statusContainer.firstChild);

        // Remove old messages to prevent clutter
        const messages = statusContainer.children;
        if (messages.length > 10) {
          statusContainer.removeChild(messages[messages.length - 1]);
        }
      }

      // Auto-refresh seat map every 30 seconds
      setInterval(loadSeatMap, 30000);
    </script>
  </body>
</html>
